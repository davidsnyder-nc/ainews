<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles independent of theme */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { border-radius: 10px; }
        ::-webkit-scrollbar-thumb { border-radius: 10px; }

        .btn {
            padding: 0.625rem 1.25rem; 
            border-radius: 0.375rem; 
            font-weight: 500; 
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent; 
            display: inline-flex; align-items: center; justify-content: center;
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0px); }
        .btn-disabled { cursor: not-allowed; opacity: 0.6; box-shadow: none; }
        .btn-disabled:hover { transform: none; }
        .btn-processing { outline-offset: 2px; animation: pulse-outline 1.2s infinite ease-in-out; }
        @keyframes pulse-outline {
            0% { outline-color: rgba(56, 189, 248, 0.5); } 
            50% { outline-color: rgba(14, 165, 233, 1); } 
            100% { outline-color: rgba(56, 189, 248, 0.5); }
        }
        #statusMessage, #errorMessage { margin-top: 1rem; font-size: 0.875rem; min-height: 1.25rem; }
        
        .tab-nav { display: flex; flex-wrap: wrap; margin-bottom: 1.5rem; }
        .tab-button { 
            padding: 0.75rem 1rem; cursor: pointer; border: none; 
            background-color: transparent; font-weight: 500; 
            position: relative; transition: color 0.2s ease-in-out; font-size: 0.875rem; 
        }
        .tab-button.active { font-weight: 600; }
        .tab-button.active::after { 
            content: ''; position: absolute; 
            bottom: -1px; left: 0; right: 0; height: 2px; 
        }

        .news-content-area {
            max-height: 13rem; 
            overflow-y: hidden;
            transition: max-height 0.4s ease-in-out;
            position: relative; 
        }
        .news-content-area.expanded {
            max-height: 1000px; 
            overflow-y: auto;
        }
        .news-content-area:not(.expanded)::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0;
            height: 3rem; pointer-events: none; 
        }

        /* Settings Panel Specific Styling */
        .settings-card {
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
        }
        .settings-card:last-child { margin-bottom: 0; }
        .settings-card-title {
            font-size: 1.125rem; font-weight: 600; 
            padding-bottom: 0.75rem; margin-bottom: 1.25rem; 
        }
        .control-group { margin-bottom: 1.5rem; }
        .control-group:last-child { margin-bottom: 0; }
        .control-group label, .toggle-switch-label-text {
            display: block; font-weight: 500; 
            margin-bottom: 0.5rem; font-size: 0.875rem; 
        }
        .api-key-link { text-decoration: underline; }

        .settings-tab-content[data-settings-tab-content="prompts"] details {
            border-radius: 0.5rem; margin-bottom: 1rem;
            transition: background-color 0.2s ease-in-out;
        }
        .settings-tab-content[data-settings-tab-content="prompts"] summary {
            padding: 0.75rem 1.25rem; font-weight: 500; cursor: pointer;
            border-radius: 0.5rem; 
            transition: background-color 0.2s ease-in-out;
            list-style-position: inside; 
        }
        .settings-tab-content[data-settings-tab-content="prompts"] summary::marker { font-size: 0.8em; }
        .settings-tab-content[data-settings-tab-content="prompts"] details[open] summary {
             border-bottom-left-radius: 0; border-bottom-right-radius: 0;
        }
        .settings-tab-content[data-settings-tab-content="prompts"] details .control-group {
            padding: 0 1.25rem 1.25rem 1.25rem; margin-bottom: 0; 
        }
        .settings-tab-content[data-settings-tab-content="prompts"] details .control-group label { margin-top: 0.75rem; }
        .settings-tab-content[data-settings-tab-content="prompts"] details textarea { width: 100%; }

        /* Blocked Terms Pill Styling */
        #blockedTermsPillContainer {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem; 
        }
        .term-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.6rem; 
            border-radius: 0.25rem; 
            font-size: 0.8rem; 
            line-height: 1;
        }
        .term-pill-remove {
            margin-left: 0.5rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        #newBlockedTermInput { 
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 0.25rem; 
            min-width: 120px; 
        }
        
        /* App Logo Text Styling */
        .app-logo-ai {
            color: #3B82F6; /* Tailwind blue-500 */
        }
        /* Theme-specific color for "News Feed" part of the logo */
        body.theme-dark .app-logo-newsfeed { color: #F9FAFB; } /* Matches text-main-heading in dark */
        body.theme-light .app-logo-newsfeed { color: #111827; } /* Matches text-main-heading in light */


        /* Dark Theme Variables & Styles */
        body.theme-dark { background-color: #111827; color: #D1D5DB; }
        body.theme-dark ::-webkit-scrollbar-track { background: #1E293B; }
        body.theme-dark ::-webkit-scrollbar-thumb { background: #0EA5E9; }
        body.theme-dark ::-webkit-scrollbar-thumb:hover { background: #0284C7; }
        body.theme-dark .main-card { background-color: #1E293B; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        body.theme-dark .btn-primary-accent { background-color: #0EA5E9; color: white; box-shadow: 0 4px 14px 0 rgba(14, 165, 233, 0.39); }
        body.theme-dark .btn-primary-accent:hover { background-color: #0284C7; box-shadow: 0 6px 20px 0 rgba(14, 165, 233, 0.23); }
        body.theme-dark .btn-secondary-outline { color: #7DD3FC; border: 1px solid #38BDF8; }
        body.theme-dark .btn-secondary-outline:hover { background-color: rgba(56, 189, 248, 0.1); color: #0EA5E9; }
        body.theme-dark .btn-category { background-color: #334155; color: #9CA3AF; border: 1px solid #4B5563; }
        body.theme-dark .btn-category:hover { background-color: #4B5563; color: #F3F4F6; border-color: #6B7280; }
        body.theme-dark .btn-category.active { background-color: #0EA5E9; color: white; border-color: #0284C7; box-shadow: 0 0 15px rgba(14, 165, 233, 0.5); }
        body.theme-dark .btn-utility { background-color: #374151; color: #D1D5DB; }
        body.theme-dark .btn-utility:hover { background-color: #4B5563; }
        body.theme-dark .btn-disabled { background-color: #374151; color: #6B7280; }
        body.theme-dark .btn-disabled:hover { background-color: #374151; }
        body.theme-dark #errorMessage { color: #F472B6; }
        body.theme-dark .input-field, 
        body.theme-dark .select-field, 
        body.theme-dark .textarea-field { 
            border-color: #4B5563; background-color: #1E293B; color: #F3F4F6; 
            padding: 0.5rem 0.75rem; border-radius: 0.375rem; border-width: 1px;
        }
        body.theme-dark .select-field {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            padding-right: 2.5rem; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239CA3AF' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1em 1em; 
        }
        body.theme-dark .input-field:focus, 
        body.theme-dark .select-field:focus, 
        body.theme-dark .textarea-field:focus,
        body.theme-dark #blockedTermsPillContainer:focus-within { 
            border-color: #38BDF8; box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3); 
        }
        body.theme-dark #newBlockedTermInput { background-color: transparent; color: #F3F4F6; }
        body.theme-dark .term-pill { background-color: #374151; color: #D1D5DB; }
        body.theme-dark .term-pill-remove:hover { color: #F472B6; }

        body.theme-dark .settings-panel-bg { background-color: #111827; border-left-color: #334155; }
        body.theme-dark .settings-card { background-color: #1F2937; border: 1px solid #374151; }
        body.theme-dark .settings-card-title { color: #E5E7EB; border-bottom-color: #374151; }
        body.theme-dark .control-group label { color: #9CA3AF; } 
        body.theme-dark .toggle-switch-label-text { color: #9CA3AF; }
        body.theme-dark .news-content-area { background-color: #1E293B; border-color: #334155; color: #D1D5DB; }
        body.theme-dark .news-content-area:not(.expanded)::after { background: linear-gradient(to bottom, rgba(30, 41, 59, 0), #1E293B 100%); }
        body.theme-dark .tab-nav { border-bottom-color: #334155; }
        body.theme-dark .tab-button { color: #9CA3AF; }
        body.theme-dark .tab-button:hover { color: #F3F4F6; }
        body.theme-dark .tab-button.active { color: #38BDF8; }
        body.theme-dark .tab-button.active::after { background-color: #38BDF8; }
        body.theme-dark .toggle-slider { background-color: #4B5563; }
        body.theme-dark input:checked + .toggle-slider { background-color: #0EA5E9; }
        body.theme-dark input:focus + .toggle-slider { box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.5); }
        body.theme-dark .api-key-link { color: #60A5FA; }
        body.theme-dark .api-key-link:hover { color: #93C5FD; }
        body.theme-dark .text-main-heading { color: #F9FAFB; } 
        body.theme-dark .text-subtle { color: #9CA3AF; }
        body.theme-dark .settings-sticky-header { background-color: #111827bb; backdrop-filter: blur(5px); } 
        body.theme-dark .modal-content { background-color: #1E293B; border-color: #334155; }
        body.theme-dark .settings-tab-content[data-settings-tab-content="prompts"] details { background-color: #2c3a4f; border: 1px solid #4B5563; }
        body.theme-dark .settings-tab-content[data-settings-tab-content="prompts"] summary { color: #CBD5E1; }
        body.theme-dark .settings-tab-content[data-settings-tab-content="prompts"] summary:hover { background-color: #374151; }
        body.theme-dark .settings-tab-content[data-settings-tab-content="prompts"] details[open] summary { border-bottom: 1px solid #4B5563; background-color: #374151;}


        /* Light Theme Variables & Styles */
        body.theme-light { background-color: #F3F4F6; color: #1F2937; }
        body.theme-light ::-webkit-scrollbar-track { background: #E5E7EB; }
        body.theme-light ::-webkit-scrollbar-thumb { background: #60A5FA; }
        body.theme-light ::-webkit-scrollbar-thumb:hover { background: #3B82F6; }
        body.theme-light .main-card { background-color: #FFFFFF; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -2px rgba(0,0,0,0.04); border: 1px solid #E5E7EB; }
        body.theme-light .btn-primary-accent { background-color: #3B82F6; color: white; box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.3); }
        body.theme-light .btn-primary-accent:hover { background-color: #2563EB; box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.2); }
        body.theme-light .btn-secondary-outline { color: #3B82F6; border: 1px solid #60A5FA; }
        body.theme-light .btn-secondary-outline:hover { background-color: rgba(96, 165, 250, 0.1); color: #2563EB; }
        body.theme-light .btn-category { background-color: #E5E7EB; color: #4B5563; border: 1px solid #D1D5DB; }
        body.theme-light .btn-category:hover { background-color: #D1D5DB; color: #1F2937; border-color: #9CA3AF; }
        body.theme-light .btn-category.active { background-color: #3B82F6; color: white; border-color: #2563EB; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        body.theme-light .btn-utility { background-color: #E5E7EB; color: #374151; }
        body.theme-light .btn-utility:hover { background-color: #D1D5DB; }
        body.theme-light .btn-disabled { background-color: #E5E7EB; color: #9CA3AF; }
        body.theme-light .btn-disabled:hover { background-color: #E5E7EB; }
        body.theme-light #errorMessage { color: #EC4899; } 
        body.theme-light .input-field, 
        body.theme-light .select-field, 
        body.theme-light .textarea-field { 
            border-color: #D1D5DB; background-color: #FFFFFF; color: #1F2937; 
            padding: 0.5rem 0.75rem; border-radius: 0.375rem; border-width: 1px;
        }
        body.theme-light .select-field {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            padding-right: 2.5rem; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1em 1em; 
        }
        body.theme-light .input-field:focus, 
        body.theme-light .select-field:focus, 
        body.theme-light .textarea-field:focus,
        body.theme-light #blockedTermsPillContainer:focus-within { 
            border-color: #60A5FA; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); 
        }
        body.theme-light #newBlockedTermInput { background-color: transparent; color: #1F2937; }
        body.theme-light .term-pill { background-color: #E5E7EB; color: #374151; }
        body.theme-light .term-pill-remove:hover { color: #EC4899; }

        body.theme-light .settings-panel-bg { background-color: #F9FAFB; border-left-color: #E5E7EB; } 
        body.theme-light .settings-card { background-color: #FFFFFF; border: 1px solid #E0E7FF; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.07), 0 1px 2px 0 rgba(0,0,0,0.03); }
        body.theme-light .settings-card-title { color: #111827; border-bottom-color: #E5E7EB; }
        body.theme-light .control-group label { color: #4B5563; } 
        body.theme-light .toggle-switch-label-text { color: #4B5563; }
        body.theme-light .news-content-area { background-color: #F9FAFB; border-color: #E5E7EB; color: #374151; }
        body.theme-light .news-content-area:not(.expanded)::after { background: linear-gradient(to bottom, rgba(249, 250, 251, 0), #F9FAFB 100%); }
        body.theme-light .tab-nav { border-bottom-color: #E5E7EB; }
        body.theme-light .tab-button { color: #6B7280; }
        body.theme-light .tab-button:hover { color: #1F2937; }
        body.theme-light .tab-button.active { color: #3B82F6; }
        body.theme-light .tab-button.active::after { background-color: #3B82F6; }
        body.theme-light .toggle-slider { background-color: #D1D5DB; } 
        body.theme-light input:checked + .toggle-slider { background-color: #3B82F6; } 
        body.theme-light input:focus + .toggle-slider { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        body.theme-light .api-key-link { color: #3B82F6; }
        body.theme-light .api-key-link:hover { color: #2563EB; }
        body.theme-light .text-main-heading { color: #111827; } 
        body.theme-light .text-subtle { color: #6B7280; }
        body.theme-light .settings-sticky-header { background-color: #f9fafbdf; backdrop-filter: blur(5px); } 
        body.theme-light .modal-content { background-color: #FFFFFF; border-color: #E5E7EB; }
        body.theme-light .settings-tab-content[data-settings-tab-content="prompts"] details { background-color: #E5E7EB; border: 1px solid #D1D5DB; }
        body.theme-light .settings-tab-content[data-settings-tab-content="prompts"] summary { color: #1F2937; }
        body.theme-light .settings-tab-content[data-settings-tab-content="prompts"] summary:hover { background-color: #D1D5DB; }
        body.theme-light .settings-tab-content[data-settings-tab-content="prompts"] details[open] summary { border-bottom: 1px solid #D1D5DB; background-color: #D1D5DB;}


        .toggle-switch-container { display: flex; align-items: center; }
        .toggle-switch-label-text { margin-right: 0.75rem; font-size: 0.875rem; font-weight: 500; }
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .4s; border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider:before { transform: translateX(20px); }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="w-full max-w-6xl mx-auto mb-8 md:mb-12 flex justify-between items-center">
        <div id="appLogoContainer" class="flex items-center">
            <h1 class="text-2xl md:text-3xl font-bold">
                <span class="app-logo-ai">AI</span>
                <span class="app-logo-newsfeed"> News Feed</span>
            </h1>
        </div>

        <div class="flex items-center space-x-2">
            <button id="resetAppBtn" class="btn btn-secondary-outline text-xs px-3 py-1.5 md:px-4 md:py-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15" />
                </svg>
                Reset
            </button>
            <button id="settingsBtn" class="btn btn-secondary-outline text-xs px-3 py-1.5 md:px-4 md:py-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Settings
            </button>
        </div>
    </header>

    <main class="w-full max-w-6xl mx-auto">
        <section class="mb-8 p-6 main-card rounded-xl">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                <div class="control-group mb-4 md:mb-0 md:mr-6 flex-grow">
                    <label for="timeFrameSelector" class="text-subtle block mb-1">Time Frame</label>
                    <select id="timeFrameSelector" class="select-field">
                        <option value="24h" selected>Last 24 hours</option>
                        <option value="7d">Last 7 days</option>
                        <option value="30d">Last 30 days</option>
                        <option value="1y">Past Year</option>
                    </select>
                </div>
                <div class="control-group mb-4 md:mb-0 toggle-switch-container md:items-center">
                    <span class="toggle-switch-label-text">Select All Categories:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="selectAllCategoriesToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
             <button id="addCustomStoryBtn" class="btn btn-secondary-outline text-sm w-full md:w-auto mb-6">
                Add Custom Story
            </button>
            <h2 class="text-xl font-semibold text-main-heading mb-4 text-left">Select News Categories</h2>
            <div class="category-button-group grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                <button data-category="tech" class="btn btn-category">Tech</button>
                <button data-category="general" class="btn btn-category">General</button>
                <button data-category="movies_tv" class="btn btn-category">Movies & TV</button>
                <button data-category="automotive" class="btn btn-category">Automotive</button>
                <button data-category="lifestyle" class="btn btn-category">Lifestyle</button>
                <button data-category="science" class="btn btn-category">Science</button>
                <button data-category="business" class="btn btn-category">Business</button>
                <button data-category="finance" class="btn btn-category">Finance</button>
                <button data-category="politics" class="btn btn-category">Politics</button>
                <button data-category="health" class="btn btn-category">Health</button>
                <button data-category="world" class="btn btn-category">World</button>
                <button data-category="sports" class="btn btn-category">Sports</button>
                <button data-category="entertainment" class="btn btn-category">Entertainment</button>
                <button data-category="gaming" class="btn btn-category">Gaming</button>
                <button data-category="culture" class="btn btn-category">Culture</button>
                <button data-category="opinion" class="btn btn-category">Opinion</button>
                <button data-category="local" class="btn btn-category">Local</button>
                <button data-category="travel" class="btn btn-category">Travel</button>
                <button data-category="food" class="btn btn-category">Food</button>
                <button data-category="education" class="btn btn-category">Education</button>
            </div>
        </section>

        <section class="mb-8 text-center">
            <button id="generateSelectedBtn" class="btn btn-primary-accent text-base px-8 py-3 w-full md:w-auto">
                Generate Briefing
            </button>
            <div id="loader" class="loader hidden"></div>
            <div id="statusMessage" class="text-subtle mt-4 text-sm">Select categories and click generate.</div>
            <div id="errorMessage" class="mt-2 text-sm"></div>
        </section>

        <div id="customStoryModalOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden"></div>
        <div id="customStoryModal" class="fixed inset-0 flex items-center justify-center z-50 hidden p-4">
            <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-lg">
                <h3 class="text-lg font-semibold text-main-heading mb-4">Paste Your Custom Story</h3>
                <textarea id="customStoryInputModal" class="textarea-field w-full" rows="10" placeholder="Paste your custom news story text here..."></textarea>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancelCustomStoryBtn" class="btn btn-secondary-outline">Cancel</button>
                    <button id="saveCustomStoryBtn" class="btn btn-primary-accent">Save Story</button>
                </div>
            </div>
        </div>

        <div id="settingsOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden"></div>
        <div id="settingsPanel" class="settings-panel-bg fixed inset-y-0 right-0 w-full max-w-md md:max-w-lg transform translate-x-full transition-transform duration-300 ease-in-out shadow-2xl z-[70] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b sticky top-0 settings-sticky-header z-10">
                <h3 class="text-lg font-semibold text-main-heading">Application Settings</h3>
                <button id="closeSettingsBtnInPanel" class="text-slate-400 hover:text-white"> 
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="settings-tab-nav !px-4 !pt-2 sticky top-[65px] settings-sticky-header z-10">
                <button class="settings-tab-button active" data-settings-tab="general">General</button>
                <button class="settings-tab-button" data-settings-tab="newsSources">Sources</button>
                <button class="settings-tab-button" data-settings-tab="aiModels">AI Models</button>
                <button class="settings-tab-button" data-settings-tab="weather">Weather</button> 
                <button class="settings-tab-button" data-settings-tab="prompts">Prompts</button>
            </div>
            <div id="settingsPanelInner" class="flex-grow p-4 overflow-y-auto pt-6">
                 <div class="settings-tab-content active" data-settings-tab-content="general">
                    <div class="settings-card">
                        <h5 class="settings-card-title">Display & Functionality</h5>
                        <div class="control-group">
                            <label for="themeSelector">Theme</label>
                            <select id="themeSelector" class="select-field">
                                <option value="dark">Dark Mode</option>
                                <option value="light">Light Mode</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="llmSelector">AI Model for Processing</label>
                            <select id="llmSelector" class="select-field">
                                <option value="gemini" selected>Gemini</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-card">
                        <h5 class="settings-card-title">Content Customization</h5>
                        <div class="control-group">
                            <label for="newBlockedTermInput">Blocked Terms (type term, press comma)</label>
                            <div id="blockedTermsPillContainer" class="input-field w-full p-2 flex flex-wrap items-center min-h-[40px]">
                                <input type="text" id="newBlockedTermInput" class="flex-grow outline-none bg-transparent text-sm" placeholder="Add a term and press ,">
                            </div>
                            <input type="hidden" id="blockedTermsInput"> 
                            </div>
                        <div class="control-group">
                            <label for="customHeaderText">Custom Header for Copied Text</label> 
                            <input type="text" id="customHeaderText" class="input-field w-full" placeholder="e.g., For Notebook LM:">
                        </div>
                    </div>
                </div>
                <div class="settings-tab-content" data-settings-tab-content="newsSources">
                    <div class="settings-card">
                        <h5 class="settings-card-title">News Source APIs</h5>
                        <p class="text-xs text-subtle mb-4 text-left">Enable and provide API keys for news sources.</p>
                        <div class="control-group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="toggle-switch-label-text">GNews API Key: <a href="https://gnews.io/" target="_blank" class="api-key-link">(Get Key)</a></span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableGnewsToggle"><span class="toggle-slider"></span>
                                </label>
                            </div>
                            <input type="password" id="gnewsApiKey" class="input-field api-key-input w-full" placeholder="Enter GNews.io API Key">
                        </div>
                        <div class="control-group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="toggle-switch-label-text">NewsAPI.org Key: <a href="https://newsapi.org/" target="_blank" class="api-key-link">(Get Key)</a></span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableNewsApiOrgToggle"><span class="toggle-slider"></span>
                                </label>
                            </div>
                            <input type="password" id="newsapiOrgKey" class="input-field api-key-input w-full" placeholder="Enter NewsAPI.org Key">
                        </div>
                        <div class="control-group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="toggle-switch-label-text">The Guardian API Key: <a href="https://open-platform.theguardian.com/access/" target="_blank" class="api-key-link">(Get Key)</a></span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableGuardianToggle"><span class="toggle-slider"></span>
                                </label>
                            </div>
                            <input type="password" id="guardianApiKey" class="input-field api-key-input w-full" placeholder="Enter The Guardian API Key">
                        </div>
                        <div class="control-group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="toggle-switch-label-text">NY Times API Key: <a href="https://developer.nytimes.com/" target="_blank" class="api-key-link">(Get Key)</a></span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableNytToggle"><span class="toggle-slider"></span>
                                </label>
                            </div>
                            <input type="password" id="nytApiKey" class="input-field api-key-input w-full" placeholder="Enter New York Times API Key">
                        </div>
                    </div>
                </div>
                <div class="settings-tab-content" data-settings-tab-content="aiModels">
                     <div class="settings-card">
                        <h5 class="settings-card-title">AI Model APIs</h5>
                        <p class="text-xs text-subtle mb-4 text-left">API keys are stored locally in your browser. Enable and provide keys for the AI models you wish to use.</p>
                        <div class="control-group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="toggle-switch-label-text">Google Cloud API Key (Gemini)</span> 
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableGeminiToggle"><span class="toggle-slider"></span>
                                </label>
                            </div>
                            <input type="password" id="geminiApiKey" class="input-field api-key-input w-full" placeholder="Enter Google Cloud API Key">
                        </div>
                        <div class="control-group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="toggle-switch-label-text">Claude API Key</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableAnthropicToggle"><span class="toggle-slider"></span>
                                </label>
                            </div>
                            <input type="password" id="anthropicApiKey" class="input-field api-key-input w-full" placeholder="Enter Anthropic API Key">
                        </div>
                        <div class="control-group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="toggle-switch-label-text">ChatGPT API Key</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableOpenaiToggle"><span class="toggle-slider"></span>
                                </label>
                            </div>
                            <input type="password" id="openaiApiKey" class="input-field api-key-input w-full" placeholder="Enter OpenAI API Key">
                        </div>
                    </div>
                </div>
                <div class="settings-tab-content" data-settings-tab-content="weather"> 
                    <div class="settings-card">
                        <h5 class="settings-card-title">Local Weather Forecast</h5>
                        <div class="control-group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="toggle-switch-label-text">Enable Local Weather</span> 
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableWeatherToggle"><span class="toggle-slider"></span>
                                </label>
                            </div>
                             <p class="text-xs text-subtle mt-1 mb-3 text-left">If enabled, a local weather forecast will be prepended to your generated news briefings.</p>
                        </div>
                        <div class="control-group">
                            <label for="zipCodeInput">ZIP Code (US only)</label>
                            <div class="flex items-center">
                                <input type="text" id="zipCodeInput" class="input-field flex-grow mr-2" placeholder="e.g., 90210">
                                <button id="fetchCoordsBtn" class="btn btn-secondary-outline text-xs py-2 px-3">Fetch</button>
                            </div>
                            <p class="text-xs text-subtle mt-1 text-left">Auto-fills latitude & longitude.</p>
                        </div>
                        <div class="control-group">
                            <label for="latitudeInput">Latitude</label>
                            <input type="text" id="latitudeInput" class="input-field w-full" placeholder="Auto-filled or manual">
                        </div>
                        <div class="control-group">
                            <label for="longitudeInput">Longitude</label>
                            <input type="text" id="longitudeInput" class="input-field w-full" placeholder="Auto-filled or manual">
                        </div>
                    </div>
                </div>
                <div class="settings-tab-content" data-settings-tab-content="prompts">
                    <div class="settings-card">
                        <h5 class="settings-card-title">AI Prompt Templates</h5>
                        <p class="text-xs text-subtle mb-4 text-left">Customize prompts. Placeholders: <code>{{CUSTOM_HEADER}}</code>, <code>{{WEATHER_FORECAST}}</code>, <code>{{LOCATION_CONTEXT}}</code>, <code>{{PASTED_STORY_SSML}}</code>, <code>{{CATEGORY_NAME}}</code>, <code>{{TIME_FRAME_TEXT}}</code>, <code>{{RAW_NEWS_DATA}}</code>, <code>{{BLOCKED_TERMS_INSTRUCTION}}</code>, <code>{{CATEGORY_SUBJECT}}</code>, <code>{{CATEGORY_SPECIFICS}}</code>.</p>
                        <details class="mb-4">
                            <summary>News Processing Prompt</summary>
                            <div class="control-group">
                                <textarea id="promptNewsProcessing" class="textarea-field w-full" rows="6"></textarea>
                            </div>
                        </details>
                        <details>
                            <summary>Fallback Prompts</summary>
                            <div class="control-group"><label for="promptFallbackTech">Tech:</label><textarea id="promptFallbackTech" class="textarea-field w-full" rows="4"></textarea></div>
                            <div class="control-group"><label for="promptFallbackGeneral">General:</label><textarea id="promptFallbackGeneral" class="textarea-field w-full" rows="4"></textarea></div>
                            <div class="control-group"><label for="promptFallbackMoviesTv">Movies & TV:</label><textarea id="promptFallbackMoviesTv" class="textarea-field w-full" rows="4"></textarea></div>
                            <div class="control-group"><label for="promptFallbackAutomotive">Automotive:</label><textarea id="promptFallbackAutomotive" class="textarea-field w-full" rows="4"></textarea></div>
                            <div class="control-group"><label for="promptFallbackLifestyle">Lifestyle:</label><textarea id="promptFallbackLifestyle" class="textarea-field w-full" rows="4"></textarea></div>
                            <div class="control-group"><label for="promptFallbackScience">Science:</label><textarea id="promptFallbackScience" class="textarea-field w-full" rows="4"></textarea></div>
                            <div class="control-group"><label for="promptFallbackLocal">Local News:</label><textarea id="promptFallbackLocal" class="textarea-field w-full" rows="4"></textarea></div>
                        </details>
                    </div>
                </div>
            </div>
            <div class="settings-button-container p-4 border-t sticky bottom-0 settings-sticky-header">
                <button id="closeSettingsBtnPanel" class="btn btn-secondary-outline">Close</button> 
                <button id="saveSettingsBtn" class="btn btn-primary-accent">Save Settings</button>
            </div>
        </div>

        <div id="allContentWrapper" class="w-full mt-8 hidden"> 
            <div class="tab-nav"></div>
            <div class="flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4 my-6">
                <button id="copyAllGeneratedBtn" class="btn btn-success hidden w-full sm:w-auto text-sm">Copy All Stories</button>
                <button id="copyAndOpenNotebookBtn" class="btn btn-secondary-outline hidden w-full sm:w-auto text-sm">Copy All & Open NotebookLM</button>
            </div>
            
            <div id="techNewsSection" data-tab-content="tech" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Tech</h2>
                    <div class="flex space-x-2">
                        <button id="copyTechNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandTechNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="techNewsContent" class="news-content-area rounded-lg p-4">No tech stories generated yet.</div>
            </div>
            <div id="generalNewsSection" data-tab-content="general" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">General</h2>
                    <div class="flex space-x-2">
                        <button id="copyGeneralNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandGeneralNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="generalNewsContent" class="news-content-area rounded-lg p-4">No general stories generated yet.</div>
            </div>
            <div id="moviesTvNewsSection" data-tab-content="movies_tv" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Movies & TV</h2>
                    <div class="flex space-x-2">
                        <button id="copyMoviesTvNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandMoviesTvNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="moviesTvNewsContent" class="news-content-area rounded-lg p-4">No Movies & TV stories generated yet.</div>
            </div>
            <div id="automotiveNewsSection" data-tab-content="automotive" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Automotive</h2>
                    <div class="flex space-x-2">
                        <button id="copyAutomotiveNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandAutomotiveNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="automotiveNewsContent" class="news-content-area rounded-lg p-4">No automotive stories generated yet.</div>
            </div>
            <div id="lifestyleNewsSection" data-tab-content="lifestyle" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Lifestyle</h2>
                    <div class="flex space-x-2">
                        <button id="copyLifestyleNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandLifestyleNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="lifestyleNewsContent" class="news-content-area rounded-lg p-4">No lifestyle stories generated yet.</div>
            </div>
            <div id="scienceNewsSection" data-tab-content="science" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Science</h2>
                    <div class="flex space-x-2">
                        <button id="copyScienceNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandScienceNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="scienceNewsContent" class="news-content-area rounded-lg p-4">No science stories generated yet.</div>
            </div>
            <div id="businessNewsSection" data-tab-content="business" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Business</h2>
                    <div class="flex space-x-2">
                        <button id="copyBusinessNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandBusinessNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="businessNewsContent" class="news-content-area rounded-lg p-4">No business stories generated yet.</div>
            </div>
            <div id="financeNewsSection" data-tab-content="finance" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Finance</h2>
                    <div class="flex space-x-2">
                        <button id="copyFinanceNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandFinanceNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="financeNewsContent" class="news-content-area rounded-lg p-4">No finance stories generated yet.</div>
            </div>
            <div id="politicsNewsSection" data-tab-content="politics" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Politics</h2>
                    <div class="flex space-x-2">
                        <button id="copyPoliticsNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandPoliticsNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="politicsNewsContent" class="news-content-area rounded-lg p-4">No politics stories generated yet.</div>
            </div>
             <div id="healthNewsSection" data-tab-content="health" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Health</h2>
                    <div class="flex space-x-2">
                        <button id="copyHealthNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandHealthNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="healthNewsContent" class="news-content-area rounded-lg p-4">No health stories generated yet.</div>
            </div>
            <div id="worldNewsSection" data-tab-content="world" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">World</h2>
                    <div class="flex space-x-2">
                        <button id="copyWorldNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandWorldNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="worldNewsContent" class="news-content-area rounded-lg p-4">No world stories generated yet.</div>
            </div>
            <div id="sportsNewsSection" data-tab-content="sports" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Sports</h2>
                    <div class="flex space-x-2">
                        <button id="copySportsNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandSportsNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="sportsNewsContent" class="news-content-area rounded-lg p-4">No sports stories generated yet.</div>
            </div>
            <div id="entertainmentNewsSection" data-tab-content="entertainment" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Entertainment</h2>
                    <div class="flex space-x-2">
                        <button id="copyEntertainmentNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandEntertainmentNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="entertainmentNewsContent" class="news-content-area rounded-lg p-4">No entertainment stories generated yet.</div>
            </div>
            <div id="gamingNewsSection" data-tab-content="gaming" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Gaming</h2>
                    <div class="flex space-x-2">
                        <button id="copyGamingNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandGamingNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="gamingNewsContent" class="news-content-area rounded-lg p-4">No gaming stories generated yet.</div>
            </div>
            <div id="cultureNewsSection" data-tab-content="culture" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Culture</h2>
                    <div class="flex space-x-2">
                        <button id="copyCultureNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandCultureNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="cultureNewsContent" class="news-content-area rounded-lg p-4">No culture stories generated yet.</div>
            </div>
            <div id="opinionNewsSection" data-tab-content="opinion" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Opinion</h2>
                    <div class="flex space-x-2">
                        <button id="copyOpinionNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandOpinionNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="opinionNewsContent" class="news-content-area rounded-lg p-4">No opinion stories generated yet.</div>
            </div>
            <div id="localNewsSection" data-tab-content="local" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Local</h2>
                    <div class="flex space-x-2">
                        <button id="copyLocalNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandLocalNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="localNewsContent" class="news-content-area rounded-lg p-4">No local stories generated yet.</div>
            </div>
            <div id="travelNewsSection" data-tab-content="travel" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Travel</h2>
                    <div class="flex space-x-2">
                        <button id="copyTravelNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandTravelNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="travelNewsContent" class="news-content-area rounded-lg p-4">No travel stories generated yet.</div>
            </div>
            <div id="foodNewsSection" data-tab-content="food" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Food</h2>
                    <div class="flex space-x-2">
                        <button id="copyFoodNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandFoodNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="foodNewsContent" class="news-content-area rounded-lg p-4">No food stories generated yet.</div>
            </div>
            <div id="educationNewsSection" data-tab-content="education" class="news-section tab-content hidden">
                <div class="news-section-header flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-main-heading">Education</h2>
                    <div class="flex space-x-2">
                        <button id="copyEducationNewsBtn" class="btn btn-utility btn-sm text-xs hidden">Copy</button>
                        <button id="expandEducationNewsBtn" class="btn btn-utility btn-sm text-xs expand-news-btn hidden">Expand</button>
                    </div>
                </div>
                <div id="educationNewsContent" class="news-content-area rounded-lg p-4">No education stories generated yet.</div>
            </div>
        </div>
    </main>

    <script>
        // DOM Element Selectors
        const categoryButtons = document.querySelectorAll('.btn-category'); 
        const generateSelectedBtn = document.getElementById('generateSelectedBtn');
        const copyAllGeneratedBtn = document.getElementById('copyAllGeneratedBtn');
        const copyAndOpenNotebookBtn = document.getElementById('copyAndOpenNotebookBtn');
        const selectAllCategoriesToggle = document.getElementById('selectAllCategoriesToggle');
        
        const settingsBtn = document.getElementById('settingsBtn');
        const resetAppBtn = document.getElementById('resetAppBtn'); 
        const settingsPanel = document.getElementById('settingsPanel');
        const settingsPanelInner = document.getElementById('settingsPanelInner'); 
        const settingsOverlay = document.getElementById('settingsOverlay');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const closeSettingsBtnInPanel = document.getElementById('closeSettingsBtnInPanel'); 
        const closeSettingsBtnPanelBottom = document.querySelector('.settings-button-container #closeSettingsBtnPanel');
        
        const settingsTabButtons = document.querySelectorAll('.settings-tab-button');
        const settingsTabContents = document.querySelectorAll('.settings-tab-content');

        const themeSelector = document.getElementById('themeSelector'); 
        const llmSelector = document.getElementById('llmSelector');
        
        const hiddenBlockedTermsInput = document.getElementById('blockedTermsInput'); 
        const blockedTermsPillContainer = document.getElementById('blockedTermsPillContainer');
        const newBlockedTermInput = document.getElementById('newBlockedTermInput'); 
        let currentBlockedTerms = []; 

        const customHeaderTextInp = document.getElementById('customHeaderText');
        const timeFrameSelector = document.getElementById('timeFrameSelector');
        
        const addCustomStoryBtn = document.getElementById('addCustomStoryBtn');
        const customStoryModalOverlay = document.getElementById('customStoryModalOverlay');
        const customStoryModal = document.getElementById('customStoryModal');
        const customStoryInputModal = document.getElementById('customStoryInputModal'); 
        const saveCustomStoryBtn = document.getElementById('saveCustomStoryBtn');
        const cancelCustomStoryBtn = document.getElementById('cancelCustomStoryBtn');
        let internalCustomStoryValue = ""; 

        const enableWeatherToggle = document.getElementById('enableWeatherToggle');
        const zipCodeInput = document.getElementById('zipCodeInput'); 
        const fetchCoordsBtn = document.getElementById('fetchCoordsBtn'); 
        const latitudeInput = document.getElementById('latitudeInput');
        const longitudeInput = document.getElementById('longitudeInput');

        const geminiApiKeyInput = document.getElementById('geminiApiKey');
        const anthropicApiKeyInput = document.getElementById('anthropicApiKey');
        const openaiApiKeyInput = document.getElementById('openaiApiKey');
        const enableGeminiToggle = document.getElementById('enableGeminiToggle');
        const enableAnthropicToggle = document.getElementById('enableAnthropicToggle');
        const enableOpenaiToggle = document.getElementById('enableOpenaiToggle');

        const gnewsApiKeyInput = document.getElementById('gnewsApiKey');
        const enableGnewsToggle = document.getElementById('enableGnewsToggle');
        const newsapiOrgKeyInput = document.getElementById('newsapiOrgKey');
        const enableNewsApiOrgToggle = document.getElementById('enableNewsApiOrgToggle');
        const guardianApiKeyInput = document.getElementById('guardianApiKey');
        const enableGuardianToggle = document.getElementById('enableGuardianToggle');
        const nytApiKeyInput = document.getElementById('nytApiKey');
        const enableNytToggle = document.getElementById('enableNytToggle');

        const promptNewsProcessingInput = document.getElementById('promptNewsProcessing'); 
        const promptFallbackTechInput = document.getElementById('promptFallbackTech');
        const promptFallbackGeneralInput = document.getElementById('promptFallbackGeneral');
        const promptFallbackMoviesTvInput = document.getElementById('promptFallbackMoviesTv');
        const promptFallbackAutomotiveInput = document.getElementById('promptFallbackAutomotive');
        const promptFallbackLifestyleInput = document.getElementById('promptFallbackLifestyle');
        const promptFallbackScienceInput = document.getElementById('promptFallbackScience');
        const promptFallbackLocalInput = document.getElementById('promptFallbackLocal'); 

        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        const loader = document.getElementById('loader');
        
        const mainContentTabsContainer = document.querySelector('#allContentWrapper .tab-nav');
        const allContentWrapper = document.getElementById('allContentWrapper');

        const sectionDetails = {
            tech: { contentArea: document.getElementById('techNewsContent'), copyButton: document.getElementById('copyTechNewsBtn'), expandButton: document.getElementById('expandTechNewsBtn'), data: "", initialPlaceholder: "No tech stories generated yet.", button: document.querySelector('.btn-category[data-category="tech"]') },
            general: { contentArea: document.getElementById('generalNewsContent'), copyButton: document.getElementById('copyGeneralNewsBtn'), expandButton: document.getElementById('expandGeneralNewsBtn'), data: "", initialPlaceholder: "No general stories generated yet.", button: document.querySelector('.btn-category[data-category="general"]') },
            movies_tv: { contentArea: document.getElementById('moviesTvNewsContent'), copyButton: document.getElementById('copyMoviesTvNewsBtn'), expandButton: document.getElementById('expandMoviesTvNewsBtn'), data: "", initialPlaceholder: "No Movies & TV stories generated yet.", button: document.querySelector('.btn-category[data-category="movies_tv"]') },
            automotive: { contentArea: document.getElementById('automotiveNewsContent'), copyButton: document.getElementById('copyAutomotiveNewsBtn'), expandButton: document.getElementById('expandAutomotiveNewsBtn'), data: "", initialPlaceholder: "No automotive stories generated yet.", button: document.querySelector('.btn-category[data-category="automotive"]') },
            lifestyle: { contentArea: document.getElementById('lifestyleNewsContent'), copyButton: document.getElementById('copyLifestyleNewsBtn'), expandButton: document.getElementById('expandLifestyleNewsBtn'), data: "", initialPlaceholder: "No lifestyle stories generated yet.", button: document.querySelector('.btn-category[data-category="lifestyle"]') },
            science: { contentArea: document.getElementById('scienceNewsContent'), copyButton: document.getElementById('copyScienceNewsBtn'), expandButton: document.getElementById('expandScienceNewsBtn'), data: "", initialPlaceholder: "No science stories generated yet.", button: document.querySelector('.btn-category[data-category="science"]') },
            business: { contentArea: document.getElementById('businessNewsContent'), copyButton: document.getElementById('copyBusinessNewsBtn'), expandButton: document.getElementById('expandBusinessNewsBtn'), data: "", initialPlaceholder: "No business stories generated yet.", button: document.querySelector('.btn-category[data-category="business"]') },
            finance: { contentArea: document.getElementById('financeNewsContent'), copyButton: document.getElementById('copyFinanceNewsBtn'), expandButton: document.getElementById('expandFinanceNewsBtn'), data: "", initialPlaceholder: "No finance stories generated yet.", button: document.querySelector('.btn-category[data-category="finance"]') },
            politics: { contentArea: document.getElementById('politicsNewsContent'), copyButton: document.getElementById('copyPoliticsNewsBtn'), expandButton: document.getElementById('expandPoliticsNewsBtn'), data: "", initialPlaceholder: "No politics stories generated yet.", button: document.querySelector('.btn-category[data-category="politics"]') },
            health: { contentArea: document.getElementById('healthNewsContent'), copyButton: document.getElementById('copyHealthNewsBtn'), expandButton: document.getElementById('expandHealthNewsBtn'), data: "", initialPlaceholder: "No health stories generated yet.", button: document.querySelector('.btn-category[data-category="health"]') },
            world: { contentArea: document.getElementById('worldNewsContent'), copyButton: document.getElementById('copyWorldNewsBtn'), expandButton: document.getElementById('expandWorldNewsBtn'), data: "", initialPlaceholder: "No world stories generated yet.", button: document.querySelector('.btn-category[data-category="world"]') },
            sports: { contentArea: document.getElementById('sportsNewsContent'), copyButton: document.getElementById('copySportsNewsBtn'), expandButton: document.getElementById('expandSportsNewsBtn'), data: "", initialPlaceholder: "No sports stories generated yet.", button: document.querySelector('.btn-category[data-category="sports"]') },
            entertainment: { contentArea: document.getElementById('entertainmentNewsContent'), copyButton: document.getElementById('copyEntertainmentNewsBtn'), expandButton: document.getElementById('expandEntertainmentNewsBtn'), data: "", initialPlaceholder: "No entertainment stories generated yet.", button: document.querySelector('.btn-category[data-category="entertainment"]') },
            gaming: { contentArea: document.getElementById('gamingNewsContent'), copyButton: document.getElementById('copyGamingNewsBtn'), expandButton: document.getElementById('expandGamingNewsBtn'), data: "", initialPlaceholder: "No gaming stories generated yet.", button: document.querySelector('.btn-category[data-category="gaming"]') },
            culture: { contentArea: document.getElementById('cultureNewsContent'), copyButton: document.getElementById('copyCultureNewsBtn'), expandButton: document.getElementById('expandCultureNewsBtn'), data: "", initialPlaceholder: "No culture stories generated yet.", button: document.querySelector('.btn-category[data-category="culture"]') },
            opinion: { contentArea: document.getElementById('opinionNewsContent'), copyButton: document.getElementById('copyOpinionNewsBtn'), expandButton: document.getElementById('expandOpinionNewsBtn'), data: "", initialPlaceholder: "No opinion stories generated yet.", button: document.querySelector('.btn-category[data-category="opinion"]') },
            local: { contentArea: document.getElementById('localNewsContent'), copyButton: document.getElementById('copyLocalNewsBtn'), expandButton: document.getElementById('expandLocalNewsBtn'), data: "", initialPlaceholder: "No local stories generated yet.", button: document.querySelector('.btn-category[data-category="local"]') },
            travel: { contentArea: document.getElementById('travelNewsContent'), copyButton: document.getElementById('copyTravelNewsBtn'), expandButton: document.getElementById('expandTravelNewsBtn'), data: "", initialPlaceholder: "No travel stories generated yet.", button: document.querySelector('.btn-category[data-category="travel"]') },
            food: { contentArea: document.getElementById('foodNewsContent'), copyButton: document.getElementById('copyFoodNewsBtn'), expandButton: document.getElementById('expandFoodNewsBtn'), data: "", initialPlaceholder: "No food stories generated yet.", button: document.querySelector('.btn-category[data-category="food"]') },
            education: { contentArea: document.getElementById('educationNewsContent'), copyButton: document.getElementById('copyEducationNewsBtn'), expandButton: document.getElementById('expandEducationNewsBtn'), data: "", initialPlaceholder: "No education stories generated yet.", button: document.querySelector('.btn-category[data-category="education"]') }
        };
        
        const promptVersion = "_v2_zip"; 

        const defaultPrompts = {
            newsProcessing: `<speak>\n{{CUSTOM_HEADER}}\n{{WEATHER_FORECAST}}\n\n{{PASTED_STORY_SSML}}\n\nYour task is to process raw news data for the '{{CATEGORY_NAME}}' category{{LOCATION_CONTEXT}}, covering the '{{TIME_FRAME_TEXT}}'. Raw data:\n{{RAW_NEWS_DATA}}\n\nIf a custom story is provided above (between USER-PROVIDED STORY START and END), you MUST include this story verbatim as the very first story in your SSML output, immediately after any custom header and weather forecast. Then proceed with generating 4-6 additional distinct stories for the '{{CATEGORY_NAME}}' category. Otherwise (if no custom story was provided), generate 5-7 distinct stories for the '{{CATEGORY_NAME}}' category. Each story needs a headline. Rewrite in a narrative style for a 15-20 minute spoken presentation (2500-3000 words total, including any pasted story). Prioritize stories from '{{TIME_FRAME_TEXT}}'. Do not copy snippets; synthesize, rephrase, expand. Maintain factual tone. After each story's narrative, include its source and publication date (if available from the raw data) like this: <p><s>Source: [Source Name], Published: [Date].</s></p> (Omit the URL from being spoken). Use <p> for paragraphs and <s> for sentences. Use <break time="500ms"/> after headlines and between major story elements.\n{{BLOCKED_TERMS_INSTRUCTION}}\n</speak>`,
            fallbackBase: `<speak>\n{{CUSTOM_HEADER}}\n{{WEATHER_FORECAST}}\n\n{{PASTED_STORY_SSML}}\n\nIf a custom story was provided above (between USER-PROVIDED STORY START and END), you MUST include this story verbatim as the very first story in your SSML output, immediately after any custom header and weather forecast. Then generate 5-7 additional distinct, real {{CATEGORY_SUBJECT}} stories{{LOCATION_CONTEXT}}. Otherwise (if no custom story was provided), generate a collection of 6 to 8 distinct, real {{CATEGORY_SUBJECT}} stories{{LOCATION_CONTEXT}}. Total length for 15-20 minute spoken presentation (2500-3000 words, including any pasted story). News from '{{TIME_FRAME_TEXT}}' (as of today, May 28, 2025), from reputable sources. Do not invent. Each story (350-500 words) needs: {{CATEGORY_SPECIFICS}}. Clear headline for each.\n\nExample Story SSML Structure:\n<p><s>**Headline: [Catchy Headline Based on Real Event]**</s><break time="500ms"/></p>\n<p><s>[Paragraph 1: Who, what, when (including date if key and available), where from verifiable info.]</s><s>[More details, background.]</s></p>\n<p><s>[Implications, perspectives, outlook. Attribute quotes generally if needed, e.g., "industry analysts said..."]</s></p>\n<p><s>[Further development or concluding thoughts.]</s></p>\n<p><s>Source: [Source Name].</s></p>\n\nEnsure factual content and in-depth overview. Use <p> for paragraphs, <s> for sentences, and <break time="500ms"/> for pauses where natural. When relevant for context or to establish recency within the '{{TIME_FRAME_TEXT}}', mention the approximate date of the event.\n{{BLOCKED_TERMS_INSTRUCTION}}\n</speak>`
        };
        
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('theme-light');
                document.body.classList.remove('theme-dark');
            } else { 
                document.body.classList.add('theme-dark');
                document.body.classList.remove('theme-light');
            }
            localStorage.setItem('selectedAppTheme', theme);
            if(themeSelector) themeSelector.value = theme;
        }

        settingsBtn.addEventListener('click', () => {
            settingsOverlay.classList.remove('hidden');
            settingsPanel.classList.remove('translate-x-full');
            settingsPanel.classList.add('translate-x-0');
            loadPersistentSettings(); 
            if (settingsTabButtons.length > 0 && settingsTabButtons[0]) settingsTabButtons[0].click(); 
        });

        if (resetAppBtn) {
            resetAppBtn.addEventListener('click', () => {
                location.reload();
            });
        }


        function closeSettingsPanel() {
            settingsPanel.classList.add('translate-x-full');
            settingsPanel.classList.remove('translate-x-0');
            settingsOverlay.classList.add('hidden');
        }
        
        if(closeSettingsBtnInPanel) closeSettingsBtnInPanel.addEventListener('click', closeSettingsPanel);
        if(closeSettingsBtnPanelBottom) closeSettingsBtnPanelBottom.addEventListener('click', closeSettingsPanel);
        settingsOverlay.addEventListener('click', closeSettingsPanel);

        function renderBlockedTerms() {
            while (blockedTermsPillContainer.firstChild && blockedTermsPillContainer.firstChild !== newBlockedTermInput) {
                blockedTermsPillContainer.removeChild(blockedTermsPillContainer.firstChild);
            }
            currentBlockedTerms.forEach(term => {
                if (term.trim() === "") return; 
                const pill = document.createElement('span');
                pill.classList.add('term-pill');
                pill.textContent = term;
                const removeBtn = document.createElement('span');
                removeBtn.classList.add('term-pill-remove');
                removeBtn.innerHTML = '&times;'; 
                removeBtn.onclick = () => {
                    currentBlockedTerms = currentBlockedTerms.filter(t => t !== term);
                    renderBlockedTerms();
                    updateHiddenBlockedTermsInput();
                };
                pill.appendChild(removeBtn);
                blockedTermsPillContainer.insertBefore(pill, newBlockedTermInput);
            });
            updateHiddenBlockedTermsInput();
        }

        function updateHiddenBlockedTermsInput() {
            hiddenBlockedTermsInput.value = currentBlockedTerms.join(',');
        }

        newBlockedTermInput.addEventListener('keyup', (event) => {
            if (event.key === ',') {
                event.preventDefault(); 
                const term = newBlockedTermInput.value.trim();
                if (term && !currentBlockedTerms.includes(term)) {
                    currentBlockedTerms.push(term);
                    renderBlockedTerms();
                }
                newBlockedTermInput.value = ''; 
            }
        });
        newBlockedTermInput.addEventListener('blur', () => {
            const term = newBlockedTermInput.value.trim();
            if (term && !currentBlockedTerms.includes(term)) {
                currentBlockedTerms.push(term);
                renderBlockedTerms();
            }
            newBlockedTermInput.value = '';
        });
         newBlockedTermInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                 event.preventDefault(); 
                const term = newBlockedTermInput.value.trim();
                if (term && !currentBlockedTerms.includes(term)) {
                    currentBlockedTerms.push(term);
                    renderBlockedTerms();
                }
                newBlockedTermInput.value = '';
            }
        });


        saveSettingsBtn.addEventListener('click', () => {
            localStorage.setItem('selectedAppTheme', themeSelector.value); 
            applyTheme(themeSelector.value); 
            localStorage.setItem('geminiApiKey', geminiApiKeyInput.value);
            localStorage.setItem('anthropicApiKey', anthropicApiKeyInput.value);
            localStorage.setItem('openaiApiKey', openaiApiKeyInput.value);
            localStorage.setItem('enableGemini', enableGeminiToggle.checked);
            localStorage.setItem('enableAnthropic', enableAnthropicToggle.checked);
            localStorage.setItem('enableOpenai', enableOpenaiToggle.checked);
            localStorage.setItem('blockedTerms', hiddenBlockedTermsInput.value); 
            localStorage.setItem('customHeaderText', customHeaderTextInp.value);
            localStorage.setItem('gnewsApiKey', gnewsApiKeyInput.value);
            localStorage.setItem('enableGnews', enableGnewsToggle.checked);
            localStorage.setItem('newsapiOrgKey', newsapiOrgKeyInput.value);
            localStorage.setItem('enableNewsApiOrg', enableNewsApiOrgToggle.checked);
            localStorage.setItem('guardianApiKey', guardianApiKeyInput.value);
            localStorage.setItem('enableGuardian', enableGuardianToggle.checked);
            localStorage.setItem('nytApiKey', nytApiKeyInput.value);
            localStorage.setItem('enableNyt', enableNytToggle.checked);
            localStorage.setItem('enableWeather', enableWeatherToggle.checked);
            localStorage.setItem('zipCode', zipCodeInput.value); 
            localStorage.setItem('latitude', latitudeInput.value);
            localStorage.setItem('longitude', longitudeInput.value);
            localStorage.setItem('selectedLLM', llmSelector.value); 
            localStorage.setItem('selectedTimeFrame', timeFrameSelector.value);
            localStorage.setItem('promptNewsProcessing' + promptVersion, promptNewsProcessingInput.value);
            localStorage.setItem('promptFallbackTech' + promptVersion, promptFallbackTechInput.value);
            localStorage.setItem('promptFallbackGeneral' + promptVersion, promptFallbackGeneralInput.value);
            localStorage.setItem('promptFallbackMoviesTv' + promptVersion, promptFallbackMoviesTvInput.value);
            localStorage.setItem('promptFallbackAutomotive' + promptVersion, promptFallbackAutomotiveInput.value);
            localStorage.setItem('promptFallbackLifestyle' + promptVersion, promptFallbackLifestyleInput.value);
            localStorage.setItem('promptFallbackScience' + promptVersion, promptFallbackScienceInput.value);
            localStorage.setItem('promptFallbackLocal' + promptVersion, promptFallbackLocalInput.value);
            statusMessage.textContent = 'Settings saved!';
            setTimeout(() => { updateInitialStatusMessage(); }, 2000);
            closeSettingsPanel();
            updateLlmSelectorOptions(); 
        });

        function loadPersistentSettings() {
            const savedTheme = localStorage.getItem('selectedAppTheme') || 'dark'; 
            if(themeSelector) themeSelector.value = savedTheme;
            applyTheme(savedTheme);
            geminiApiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            anthropicApiKeyInput.value = localStorage.getItem('anthropicApiKey') || '';
            openaiApiKeyInput.value = localStorage.getItem('openaiApiKey') || '';
            enableGeminiToggle.checked = localStorage.getItem('enableGemini') === 'true'; 
            enableAnthropicToggle.checked = localStorage.getItem('enableAnthropic') === 'true';
            enableOpenaiToggle.checked = localStorage.getItem('enableOpenai') === 'true';
            const savedBlockedTerms = localStorage.getItem('blockedTerms') || '';
            currentBlockedTerms = savedBlockedTerms ? savedBlockedTerms.split(',').map(t => t.trim()).filter(t => t) : [];
            renderBlockedTerms(); 
            customHeaderTextInp.value = localStorage.getItem('customHeaderText') || '';
            gnewsApiKeyInput.value = localStorage.getItem('gnewsApiKey') || '';
            enableGnewsToggle.checked = localStorage.getItem('enableGnews') === 'true';
            newsapiOrgKeyInput.value = localStorage.getItem('newsapiOrgKey') || '';
            enableNewsApiOrgToggle.checked = localStorage.getItem('enableNewsApiOrg') === 'true';
            guardianApiKeyInput.value = localStorage.getItem('guardianApiKey') || '';
            enableGuardianToggle.checked = localStorage.getItem('enableGuardian') === 'true';
            nytApiKeyInput.value = localStorage.getItem('nytApiKey') || '';
            enableNytToggle.checked = localStorage.getItem('enableNyt') === 'true';
            enableWeatherToggle.checked = localStorage.getItem('enableWeather') === 'true';
            zipCodeInput.value = localStorage.getItem('zipCode') || ''; 
            latitudeInput.value = localStorage.getItem('latitude') || '';
            longitudeInput.value = localStorage.getItem('longitude') || '';
            timeFrameSelector.value = localStorage.getItem('selectedTimeFrame') || '24h';
            internalCustomStoryValue = localStorage.getItem('customStoryContent') || ""; 
            promptNewsProcessingInput.value = localStorage.getItem('promptNewsProcessing' + promptVersion) || defaultPrompts.newsProcessing;
            promptFallbackTechInput.value = localStorage.getItem('promptFallbackTech' + promptVersion) || defaultPrompts.fallbackBase.replace('{{CATEGORY_SUBJECT}}', 'technology').replace('{{CATEGORY_SPECIFICS}}', "covering verifiable innovations, new products, company updates, significant tech trends, or cybersecurity news from reputable tech news outlets and official sources.");
            promptFallbackGeneralInput.value = localStorage.getItem('promptFallbackGeneral' + promptVersion) || defaultPrompts.fallbackBase.replace('{{CATEGORY_SUBJECT}}', 'general topics').replace('{{CATEGORY_SPECIFICS}}', "covering a variety of current events from reputable sources. Focus on major world events, significant societal developments, or noteworthy human interest stories.");
            promptFallbackMoviesTvInput.value = localStorage.getItem('promptFallbackMoviesTv' + promptVersion) || defaultPrompts.fallbackBase.replace('{{CATEGORY_SUBJECT}}', 'movies and TV').replace('{{CATEGORY_SPECIFICS}}', "covering verifiable new releases, casting announcements, production updates, box office analysis, or critical reviews of films and television shows, based on information from established entertainment news sources and official studio announcements.");
            promptFallbackAutomotiveInput.value = localStorage.getItem('promptFallbackAutomotive' + promptVersion) || defaultPrompts.fallbackBase.replace('{{CATEGORY_SUBJECT}}', 'automotive topics').replace('{{CATEGORY_SPECIFICS}}', "covering verifiable new vehicle releases, automotive industry trends, technological advancements in cars (like EVs, autonomous driving), motorsport news, or significant company news from reputable automotive publications and official sources.");
            promptFallbackLifestyleInput.value = localStorage.getItem('promptFallbackLifestyle' + promptVersion) || defaultPrompts.fallbackBase.replace('{{CATEGORY_SUBJECT}}', 'lifestyle topics').replace('{{CATEGORY_SPECIFICS}}', "covering verifiable trends and news in areas such as home and garden, wellness, travel, personal development, fashion, or food, based on information from established lifestyle publications and reputable sources.");
            promptFallbackScienceInput.value = localStorage.getItem('promptFallbackScience' + promptVersion) || defaultPrompts.fallbackBase.replace('{{CATEGORY_SUBJECT}}', 'science and nature').replace('{{CATEGORY_SPECIFICS}}', "covering verifiable scientific discoveries, research breakthroughs, space exploration, environmental news, and nature-related developments from reputable scientific journals and established science news outlets.");
            promptFallbackLocalInput.value = localStorage.getItem('promptFallbackLocal' + promptVersion) || defaultPrompts.fallbackBase.replace('{{CATEGORY_SUBJECT}}', 'local news').replace('{{CATEGORY_SPECIFICS}}', "covering community events, local government news, human interest stories, and developments relevant to the specified area (e.g., {{LOCATION_CONTEXT}}).");
            updateLlmSelectorOptions(); 
        }
        
        async function geocodeZipCode() {
            const zip = zipCodeInput.value.trim();
            if (!zip || !/^\d{5}$/.test(zip)) {
                errorMessage.textContent = zip ? "Invalid ZIP code format. Please use 5 digits." : "Please enter a ZIP code.";
                setTimeout(() => errorMessage.textContent = '', 3000);
                return;
            }
            statusMessage.textContent = `Fetching coordinates for ZIP ${zip}...`;
            loader.classList.remove('hidden');
            errorMessage.textContent = ''; 
            try {
                const response = await fetch(`https://api.zippopotam.us/us/${zip}`);
                if (!response.ok) throw new Error(`Failed to fetch location for ZIP ${zip}. Status: ${response.status}`);
                const data = await response.json();
                if (data && data.places && data.places.length > 0) {
                    const place = data.places[0];
                    latitudeInput.value = place.latitude;
                    longitudeInput.value = place.longitude;
                    statusMessage.textContent = `Coordinates found for ${place['place name']}, ${place['state abbreviation']}.`;
                    localStorage.setItem('userLocationInfo', `${place['place name']}, ${place['state abbreviation']} (ZIP: ${zip})`); 
                } else {
                    throw new Error(`No location data found for ZIP ${zip}.`);
                }
            } catch (error) {
                console.error("Geocoding error:", error);
                errorMessage.textContent = error.message;
                latitudeInput.value = ''; longitudeInput.value = '';
                localStorage.removeItem('userLocationInfo');
            } finally {
                loader.classList.add('hidden');
                setTimeout(() => {
                    if (statusMessage.textContent.startsWith('Fetching') || statusMessage.textContent.startsWith('Coordinates found')) {
                        updateInitialStatusMessage(); 
                    }
                }, 3000);
            }
        }
        if (fetchCoordsBtn) fetchCoordsBtn.addEventListener('click', geocodeZipCode);

        function updateLlmSelectorOptions() {
            const previouslySelectedLLM = localStorage.getItem('selectedLLM') || ''; 
            llmSelector.innerHTML = ''; 
            let optionsAdded = 0;
            if (localStorage.getItem('enableGemini') === 'true' && localStorage.getItem('geminiApiKey')) { 
                llmSelector.innerHTML += '<option value="gemini">Gemini</option>'; optionsAdded++;
            }
            if (localStorage.getItem('enableAnthropic') === 'true' && localStorage.getItem('anthropicApiKey')) {
                llmSelector.innerHTML += '<option value="anthropic">Claude</option>'; optionsAdded++;
            }
            if (localStorage.getItem('enableOpenai') === 'true' && localStorage.getItem('openaiApiKey')) {
                llmSelector.innerHTML += '<option value="openai">ChatGPT</option>'; optionsAdded++;
            }
            if (optionsAdded === 0) {
                llmSelector.innerHTML = '<option value="" disabled selected>No models enabled in Settings</option>';
            } else {
                if (Array.from(llmSelector.options).some(opt => opt.value === previouslySelectedLLM) && previouslySelectedLLM) {
                    llmSelector.value = previouslySelectedLLM;
                } else if (llmSelector.options.length > 0) { 
                    llmSelector.value = llmSelector.options[0].value; 
                }
            }
            updateInitialStatusMessage();
        }

        function updateInitialStatusMessage() {
             if (llmSelector.options.length === 0 || (llmSelector.options.length > 0 && llmSelector.options[0].disabled)) {
                 statusMessage.textContent = 'No AI models enabled. Please configure API keys and enable models in Settings.';
             } else {
                 statusMessage.textContent = 'Select categories, then click "Generate Briefing" or configure settings.';
             }
        }
        
        settingsTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                settingsTabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const tabName = button.dataset.settingsTab;
                settingsTabContents.forEach(content => {
                    content.classList.toggle('active', content.dataset.settingsTabContent === tabName);
                });
            });
        });

        function updateMainContentTabs(activeCategoriesWithContent) {
            mainContentTabsContainer.innerHTML = ''; 
            let firstActiveTabKey = null;
            const categoriesToDisplay = activeCategoriesWithContent.filter(categoryKey => 
                sectionDetails[categoryKey] && sectionDetails[categoryKey].data && sectionDetails[categoryKey].data.trim() !== ""
            );
            categoriesToDisplay.forEach((categoryKey, index) => {
                const tabButton = document.createElement('button');
                tabButton.className = 'tab-button'; 
                tabButton.dataset.tab = categoryKey;
                tabButton.textContent = categoryKey.replace(/_/g, ' & ').replace(/\b\w/g, l => l.toUpperCase());
                if (index === 0) { 
                    firstActiveTabKey = categoryKey;
                    tabButton.classList.add('active');
                }
                tabButton.addEventListener('click', () => {
                    document.querySelectorAll('#allContentWrapper .tab-nav .tab-button').forEach(btn => btn.classList.remove('active'));
                    tabButton.classList.add('active');
                    document.querySelectorAll('#allContentWrapper .tab-content').forEach(content => {
                        content.classList.toggle('active', content.dataset.tabContent === categoryKey);
                        content.classList.toggle('hidden', content.dataset.tabContent !== categoryKey); 
                    });
                });
                mainContentTabsContainer.appendChild(tabButton);
            });
            Object.keys(sectionDetails).forEach(key => {
                const sectionEl = document.querySelector(`.news-section[data-tab-content="${key}"]`);
                if (sectionEl) {
                    const hasContent = categoriesToDisplay.includes(key);
                    sectionEl.classList.toggle('hidden', !hasContent || (firstActiveTabKey !== null && key !== firstActiveTabKey) ); 
                    sectionEl.classList.toggle('active', key === firstActiveTabKey && hasContent);
                }
            });
        }

        categoryButtons.forEach(button => {
            button.addEventListener('click', () => button.classList.toggle('active'));
        });
        selectAllCategoriesToggle.addEventListener('change', (event) => {
            categoryButtons.forEach(button => button.classList.toggle('active', event.target.checked));
        });

        if (addCustomStoryBtn) addCustomStoryBtn.addEventListener('click', () => {
            customStoryInputModal.value = internalCustomStoryValue; 
            customStoryModalOverlay.classList.remove('hidden');
            customStoryModal.classList.remove('hidden');
        });
        if (cancelCustomStoryBtn) cancelCustomStoryBtn.addEventListener('click', () => {
            customStoryModalOverlay.classList.add('hidden');
            customStoryModal.classList.add('hidden');
        });
        if (saveCustomStoryBtn) saveCustomStoryBtn.addEventListener('click', () => {
            internalCustomStoryValue = customStoryInputModal.value;
            localStorage.setItem('customStoryContent', internalCustomStoryValue); 
            customStoryModalOverlay.classList.add('hidden');
            customStoryModal.classList.add('hidden');
            statusMessage.textContent = "Custom story saved.";
            setTimeout(() => updateInitialStatusMessage(), 2000);
        });
        if (customStoryModalOverlay) customStoryModalOverlay.addEventListener('click', () => { 
            customStoryModalOverlay.classList.add('hidden');
            customStoryModal.classList.add('hidden');
        });

        generateSelectedBtn.addEventListener('click', handleGenerateSelectedNews);
        copyAndOpenNotebookBtn.addEventListener('click', copyAllAndOpenNotebookLM);
        copyAllGeneratedBtn.addEventListener('click', copyAllGeneratedContentToClipboard);

        Object.keys(sectionDetails).forEach(key => {
            const config = sectionDetails[key];
            if (config.copyButton) { 
                config.copyButton.addEventListener('click', () => copyCategoryContentToClipboard(key));
            }
            if (config.expandButton) {
                config.expandButton.addEventListener('click', () => {
                    config.contentArea.classList.toggle('expanded');
                    config.expandButton.textContent = config.contentArea.classList.contains('expanded') ? 'Collapse' : 'Expand';
                });
            }
        });

        function getDatesForTimeFrame(timeFrame) { return { from: new Date(Date.now() - ({'24h':1,'7d':7,'30d':30,'1y':365}[timeFrame] || 1) * 86400000).toISOString().split('T')[0], to: new Date().toISOString().split('T')[0] }; }
        function getNYTDatesForTimeFrame(timeFrame) { const n=new Date(),e=d=>String(d).padStart(2,'0');let b=new Date(n);({'24h':()=>b.setDate(n.getDate()-1),'7d':()=>b.setDate(n.getDate()-7),'30d':()=>b.setMonth(n.getMonth()-1),'1y':()=>b.setFullYear(n.getFullYear()-1)}[timeFrame]||(()=>b.setDate(n.getDate()-1)))();return{begin_date:`${b.getFullYear()}${e(b.getMonth()+1)}${e(b.getDate())}`,end_date:`${n.getFullYear()}${e(n.getMonth()+1)}${e(n.getDate())}`};}
        async function fetchLocalWeather() { if(localStorage.getItem('enableWeather')!=='true')return"";const t=latitudeInput.value,e=longitudeInput.value;if(!t||!e)return console.warn("Weather enabled but lat/lon missing."),"<p><s>Local weather could not be fetched.</s></p><break time=\"500ms\"/>\n";try{const n=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${t}&longitude=${e}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=auto`);if(!n.ok)throw new Error(`Weather API error (${n.status})`);const a=await n.json();let o="<p><s>--- CURRENT LOCAL WEATHER ---</s></p>\n";return a.current_weather&&(o+=`<p><s>Temperature: ${a.current_weather.temperature}F.</s><s>Wind: ${a.current_weather.windspeed} mph.</s></p>\n`),a.daily&&(o+=`<p><s>Today's Forecast: Max ${a.daily.temperature_2m_max[0]}F, Min ${a.daily.temperature_2m_min[0]}F.</s></p>\n`),o+="<p><s>(Weather data from Open-Meteo)</s></p>\n<break time=\"700ms\"/>\n"}catch(t){return console.error("Failed to fetch weather:",t),"<p><s>Error fetching local weather.</s></p><break time=\"500ms\"/>\n"} }
        async function fetchNewsFromSources(categoryKey, blockedTerms, timeFrame) { let allFetchedArticles=[],dates=getDatesForTimeFrame(timeFrame),nytDates=getNYTDatesForTimeFrame(timeFrame),fetchErrorOccurred=!1,sourcesAttempted=0,sourcesSucceeded=0,maxArticlesPerSource=7;async function fetchWithTimeout(e,t,o=8e3){const n=new AbortController,r=setTimeout(()=>n.abort(),o),s=await fetch(e,{...t,signal:n.signal});return clearTimeout(r),s}const categoryKeywords={tech:"technology OR innovation OR gadgets OR software OR AI OR computing OR science",general:"world news OR current events OR major developments",movies_tv:"movies OR tv OR television OR cinema OR film OR streaming",automotive:"cars OR automotive OR vehicles OR electric vehicles OR auto industry",lifestyle:"lifestyle OR home and garden OR wellness OR travel OR personal development OR hobbies",science:"science OR nature OR research OR discovery OR environment OR space OR physics OR biology OR chemistry",business:"business OR economy OR markets OR companies OR startups",finance:"finance OR stocks OR investment OR banking OR financial planning",politics:"politics OR government OR elections OR policy",health:"health OR medicine OR wellness OR fitness OR nutrition",world:"world affairs OR international relations OR global events",sports:"sports OR athletics OR games OR matches OR tournaments",entertainment:"entertainment news OR celebrity OR arts OR music OR events",gaming:"video games OR gaming OR esports OR game development",culture:"culture OR arts OR society OR traditions OR heritage",opinion:"opinion OR editorial OR commentary OR viewpoints",local:"news",travel:"travel OR tourism OR destinations OR vacation",food:"food OR cuisine OR restaurants OR recipes OR cooking",education:"education OR schools OR learning OR universities OR students"},guardianSections={tech:"technology",general:"world|us-news|uk-news",movies_tv:"film|tv-and-radio|stage",automotive:"technology|business|environment",lifestyle:"lifeandstyle|fashion|food|travel",science:"science|environment",business:"business|money",finance:"business|money|economics",politics:"politics|us-news|uk-news",health:"society|lifeandstyle",world:"world",sports:"sport",entertainment:"culture|film|tv-and-radio|music|games|stage",gaming:"games|technology",culture:"culture|artanddesign|books|music",opinion:"commentisfree",local:"world",travel:"travel",food:"food|lifeandstyle",education:"education"};let queryForNewsApi=categoryKeywords[categoryKey]||categoryKey;"local"===categoryKey&&localStorage.getItem("userLocationInfo")&&(queryForNewsApi=`${localStorage.getItem("userLocationInfo").split(" (ZIP:")[0]} news OR local news ${localStorage.getItem("userLocationInfo").split(" (ZIP:")[0]}`);if("true"===localStorage.getItem("enableGnews")&&localStorage.getItem("gnewsApiKey")){sourcesAttempted++;try{const e=localStorage.getItem("gnewsApiKey"),t=`https://gnews.io/api/v4/search?q=${encodeURIComponent(queryForNewsApi)}&lang=en&max=${maxArticlesPerSource}&sortby=publishedAt&apikey=${e}`;statusMessage.textContent=`Fetching from GNews for ${categoryKey.replace(/_/g," & ")}...`;const o=await fetchWithTimeout(t);if(!o.ok)throw new Error(`GNews API Error (${o.status})`);const n=await o.json();n.articles&&n.articles.length>0&&(sourcesSucceeded++,n.articles.forEach(e=>allFetchedArticles.push({title:e.title,description:e.description,content:e.content,url:e.url,source:`GNews - ${e.source.name}`,publishedAt:e.publishedAt})))}catch(e){console.error("GNews fetch error:",e),fetchErrorOccurred=!0}}if("true"===localStorage.getItem("enableNewsApiOrg")&&localStorage.getItem("newsapiOrgKey")){sourcesAttempted++;try{const e=localStorage.getItem("newsapiOrgKey"),t=`https://newsapi.org/v2/everything?q=${encodeURIComponent(queryForNewsApi)}&language=en&pageSize=${maxArticlesPerSource}&from=${dates.from}&to=${dates.to}&sortBy=relevancy&apiKey=${e}`;statusMessage.textContent=`Fetching from NewsAPI.org for ${categoryKey.replace(/_/g," & ")}...`;const o=await fetchWithTimeout(t);if(!o.ok)throw new Error(`NewsAPI.org Error (${o.status})`);const n=await o.json();n.articles&&n.articles.length>0&&(sourcesSucceeded++,n.articles.forEach(e=>allFetchedArticles.push({title:e.title,description:e.description,content:e.content,url:e.url,source:`NewsAPI.org - ${e.source.name}`,publishedAt:e.publishedAt})))}catch(e){console.error("NewsAPI.org fetch error:",e),fetchErrorOccurred=!0}}if("true"===localStorage.getItem("enableGuardian")&&localStorage.getItem("guardianApiKey")){sourcesAttempted++;try{const e=localStorage.getItem("guardianApiKey"),t="local"===categoryKey?(localStorage.getItem("userLocationInfo")?.split(" (ZIP:")[0]||"local news"):categoryKeywords[categoryKey]||categoryKey,o=guardianSections[categoryKey]||categoryKey.replace(/_/g,"-"),n=`https://content.guardianapis.com/search?q=${encodeURIComponent(t)}&section=${o}&show-fields=bodyText,headline,trailText&page-size=${maxArticlesPerSource}&from-date=${dates.from}&to-date=${dates.to}&api-key=${e}`;statusMessage.textContent=`Fetching from The Guardian for ${categoryKey.replace(/_/g," & ")}...`;const r=await fetchWithTimeout(n);if(!r.ok)throw new Error(`Guardian API Error (${r.status})`);const s=await r.json();s.response&&s.response.results&&s.response.results.length>0&&(sourcesSucceeded++,s.response.results.forEach(e=>allFetchedArticles.push({title:e.webTitle,description:e.fields.trailText,content:e.fields.bodyText?String(e.fields.bodyText).substring(0,1e3)+"...":"",url:e.webUrl,source:"The Guardian",publishedAt:e.webPublicationDate})))}catch(e){console.error("Guardian fetch error:",e),fetchErrorOccurred=!0}}if("true"===localStorage.getItem("enableNyt")&&localStorage.getItem("nytApiKey")){sourcesAttempted++;try{const e=localStorage.getItem("nytApiKey"),t="local"===categoryKey?(localStorage.getItem("userLocationInfo")?.split(" (ZIP:")[0]||"local news"):categoryKeywords[categoryKey]||categoryKey.replace(/_/g," "),o=`https://api.nytimes.com/svc/search/v2/articlesearch.json?q=${encodeURIComponent(t)}&begin_date=${nytDates.begin_date}&end_date=${nytDates.end_date}&sort=newest&api-key=${e}`;statusMessage.textContent=`Fetching from NY Times for ${categoryKey.replace(/_/g," & ")}...`;const n=await fetchWithTimeout(o);if(!n.ok)throw new Error(`NYT API Error (${n.status})`);const r=await n.json();r.response&&r.response.docs&&r.response.docs.length>0&&(sourcesSucceeded++,r.response.docs.slice(0,maxArticlesPerSource).forEach(e=>allFetchedArticles.push({title:e.headline.main,description:e.snippet,content:e.lead_paragraph,url:e.web_url,source:e.source||"The New York Times",publishedAt:e.pub_date})))}catch(e){console.error("NYT fetch error:",e),fetchErrorOccurred=!0}}if(0===allFetchedArticles.length)return sourcesAttempted>0&&0===sourcesSucceeded&&fetchErrorOccurred?"Error fetching from enabled news sources. The AI will generate content from its knowledge.":"No recent articles found from enabled news sources for this category. The AI will generate content from its knowledge.";const uniqueArticles=Array.from(new Set(allFetchedArticles.map(e=>e.title))).map(e=>allFetchedArticles.find(t=>t.title===e));let rawNewsData="Fetched Articles (Please synthesize and expand upon these, focusing on the '{{TIME_FRAME_TEXT}}' timeframe):\n\n";return uniqueArticles.slice(0,25).forEach((e,t)=>{rawNewsData+=`Article ${t+1}:\n`,rawNewsData+=`Title: ${e.title||"N/A"}\n`,rawNewsData+=`Description: ${e.description||"N/A"}\n`,rawNewsData+=`Content Snippet: ${e.content?String(e.content).substring(0,500)+"...":"N/A"}\n`,rawNewsData+=`Source: ${e.source||"N/A"}\n`,rawNewsData+=`Published: ${e.publishedAt||"N/A"}\n`,rawNewsData+=`URL: ${e.url||"N/A"}\n\n`}),rawNewsData }
        async function callSelectedLLM(prompt, loadingMessage) { const t=llmSelector.value;if(!t)return errorMessage.textContent="No AI model selected or enabled. Please check Settings.",statusMessage.textContent="Generation failed: No AI model available.",Promise.reject("No AI model selected");statusMessage.textContent=loadingMessage,loader.classList.remove("hidden"),errorMessage.textContent="",disableAllActionButtons();let e,o,n,r={"Content-Type":"application/json"},a;console.log(`Calling LLM: ${t} with prompt (first 200 chars):`,prompt.substring(0,200)+"...");try{switch(t){case"gemini":if(!(e=localStorage.getItem("geminiApiKey")))throw new Error("Gemini API Key not found in settings. Please add it to use Gemini.");o=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${e}`,n={contents:[{role:"user",parts:[{text:prompt}]}]},a=e=>e.candidates[0]?.content?.parts[0]?.text;break;case"anthropic":if(!(e=localStorage.getItem("anthropicApiKey")))throw new Error("Anthropic API Key not found or Claude not enabled in settings.");o="https://api.anthropic.com/v1/messages",r["x-api-key"]=e,r["anthropic-version"]="2023-06-01",n={model:"claude-3-opus-20240229",max_tokens:4096,messages:[{role:"user",content:prompt}]},a=e=>e.content[0]?.text;break;case"openai":if(!(e=localStorage.getItem("openaiApiKey")))throw new Error("OpenAI API Key not found or ChatGPT not enabled in settings.");o="https://api.openai.com/v1/chat/completions",r.Authorization=`Bearer ${e}`,n={model:"gpt-3.5-turbo-0125",messages:[{role:"user",content:prompt}]},a=e=>e.choices[0]?.message?.content;break;default:throw new Error("Invalid LLM selected.")}const s=await fetch(o,{method:"POST",headers:r,body:JSON.stringify(n)});if(!s.ok){const c=await s.json();console.error(`${t} API Error Data:`,c);let i=c.error?.message||c.error_description||JSON.stringify(c);"anthropic"===t&&"error"===c.type&&c.error&&(i=`${c.error.type}: ${c.error.message}`),"openai"===t&&c.error&&(i=c.error.message);throw new Error(`${t} API Error (${s.status}): ${i}`)}const l=await s.json(),p=a(l);if(p)return p;console.warn(`Unexpected response structure from ${t} API:`,l);throw new Error(`Couldn't process the response from ${t}.`)}catch(e){return console.error(`Error calling ${t} API:`,e),errorMessage.textContent=`API Interaction Failed with ${t}: ${e.message}. Check API key and console.`,Promise.reject(e)}finally{loader.classList.add("hidden"),enableAllActionButtons()} }
        function getPromptFromStorage(promptKey, categoryKey) { const e=promptKey+promptVersion,t=localStorage.getItem(e);if(t)return console.log("Loaded prompt from localStorage:",e),t;console.log("Using default prompt for:",promptKey,"(localStorage key not found:",e+")");if("promptNewsProcessing"===promptKey)return defaultPrompts.newsProcessing;if("promptFallbackLocal"===promptKey)return defaultPrompts.fallbackBase.replace("{{CATEGORY_SUBJECT}}","local news").replace("{{CATEGORY_SPECIFICS}}","covering community events, local government news, human interest stories, and developments relevant to the specified area (e.g., {{LOCATION_CONTEXT}}).");let o="general topics",n="covering a variety of current events from reputable sources. Focus on major world events, significant societal developments, or noteworthy human interest stories.";return o=categoryKey.replace(/_/g," "),n=({tech:"covering verifiable innovations, new products, company updates, significant tech trends, or cybersecurity news from reputable tech news outlets and official sources.",movies_tv:"covering verifiable new releases, casting announcements, production updates, box office analysis, or critical reviews of films and television shows, based on information from established entertainment news sources and official studio announcements.",automotive:"covering verifiable new vehicle releases, automotive industry trends, technological advancements in cars (like EVs, autonomous driving), motorsport news, or significant company news from reputable automotive publications and official sources.",lifestyle:"covering verifiable trends and news in areas such as home and garden, wellness, travel, personal development, fashion, or food, based on information from established lifestyle publications and reputable sources.",science:"covering verifiable scientific discoveries, research breakthroughs, space exploration, environmental news, and nature-related developments from reputable scientific journals and established science news outlets.",business:"covering significant company news, market trends, economic developments, entrepreneurship, and corporate strategies from reputable business news sources.",finance:"covering stock market analysis, investment strategies, personal finance advice, banking news, and financial regulations from established financial news outlets.",politics:"covering government activities, elections, legislative developments, political campaigns, and international relations from reputable political news sources.",health:"covering medical breakthroughs, public health issues, wellness advice, fitness trends, and nutrition information from trusted health organizations and news sources.",world:"covering major international events, global affairs, conflicts, diplomacy, and significant developments from around the world from reputable international news services.",sports:"covering results, analysis, and news from various sports including major leagues, tournaments, and athletic achievements from established sports news outlets.",entertainment:"covering celebrity news, arts, music releases, cultural events, and general entertainment industry updates from reputable entertainment news sources.",gaming:"covering video game releases, eSports, gaming industry news, hardware reviews, and trends in interactive entertainment from established gaming publications.",culture:"covering societal trends, arts, literature, traditions, heritage, and cultural phenomena from reputable cultural news sources and publications.",opinion:"presenting diverse viewpoints, editorials, and commentary on current events and societal issues from various columnists and thought leaders.",travel:"covering travel destinations, tourism news, travel tips, cultural experiences, and adventure travel from reputable travel publications.",food:"covering culinary trends, restaurant reviews, recipes, food industry news, and nutritional information from established food and cooking publications.",education:"covering news related to schools, universities, educational policies, learning methods, and advancements in the field of education from reputable sources."}[categoryKey]||n),defaultPrompts.fallbackBase.replace("{{CATEGORY_SUBJECT}}",o).replace("{{CATEGORY_SPECIFICS}}",n)}
        function getTimeFrameText(timeFrameValue) { switch(timeFrameValue){case"24h":return"last 24 hours";case"7d":return"last 7 days";case"30d":return"last 30 days";case"1y":return"past year";default:return"recent"}}

        async function handleGenerateSelectedNews() {
            const selectedCategories = Array.from(categoryButtons).filter(b => b.classList.contains('active')).map(b => b.dataset.category);
            if (selectedCategories.length === 0) {
                errorMessage.textContent = "Please select at least one category."; statusMessage.textContent = ""; return;
            }
            const selectedLLMName = llmSelector.options[llmSelector.selectedIndex]?.text || "No Model";
            if (!llmSelector.value) {
                 errorMessage.textContent = "No AI model selected/enabled. Check Settings."; statusMessage.textContent = "Generation failed."; return;
            }
            localStorage.setItem('selectedLLM', llmSelector.value); 
            localStorage.setItem('selectedTimeFrame', timeFrameSelector.value);
            disableAllActionButtons(); 
            let overallSuccess = true, anyContentGenerated = false;
            
            mainContentTabsContainer.innerHTML = ''; 
            document.querySelectorAll('#allContentWrapper .tab-content').forEach(tc => { 
                const categoryKey = tc.dataset.tabContent;
                const config = sectionDetails[categoryKey];
                if (config) {
                    config.contentArea.innerHTML = config.initialPlaceholder;
                    config.contentArea.classList.remove('expanded');
                    if(config.copyButton) config.copyButton.classList.add('hidden');
                    if(config.expandButton) {
                        config.expandButton.classList.add('hidden');
                        config.expandButton.textContent = 'Expand';
                    }
                }
                tc.classList.add('hidden'); 
            });

            for (let i = 0; i < selectedCategories.length; i++) {
                const categoryKey = selectedCategories[i];
                const categoryDisplayName = categoryKey.replace(/_/g, ' & ');
                const categoryButton = sectionDetails[categoryKey]?.button;
                statusMessage.textContent = `Generating (${i + 1}/${selectedCategories.length}): ${categoryDisplayName} with ${selectedLLMName}...`;
                if (categoryButton) categoryButton.classList.add('btn-processing');
                try {
                    await handleGenerateCategoryNews(categoryKey, true); 
                    if (sectionDetails[categoryKey].data?.trim()) anyContentGenerated = true;
                } catch (error) {
                    console.error(`Error for ${categoryDisplayName}:`, error); overallSuccess = false; 
                } finally {
                    if (categoryButton) categoryButton.classList.remove('btn-processing');
                }
            }
            updateMainContentTabs(selectedCategories); 
            statusMessage.textContent = overallSuccess && anyContentGenerated ? "Selected categories processed!" : (anyContentGenerated ? "Processed, some issues or no content." : "Processing complete. No content generated.");
            enableAllActionButtons(); 
            updateCopyAllGeneratedButtonVisibility();
        }
        
        function stripSSML(ssmlText) { return ssmlText?(ssmlText=(ssmlText=(ssmlText=(ssmlText=(ssmlText=(ssmlText=ssmlText.replace(/<\/?speak>/gi,"")).replace(/<p><s>(.*?)<\/s><\/p>/gi,"$1\n")).replace(/<s>(.*?)<\/s>/gi,"$1 ")).replace(/<p>(.*?)<\/p>/gi,"$1\n")).replace(/<break\s+time=".*?"\s*\/>/gi,"\n")).replace(/<[^>]+>/g,"")).replace(/\n\s*\n/g,"\n\n").trim():"" }
        function formatPastedStoryToSSML(pastedText) { if(!pastedText||""===pastedText.trim())return"";const e=pastedText.replace(/\n\s*\n/g,"\n").trim().split("\n").map(e=>{const t=e.split(/(?<=[.?!])\s+/).filter(e=>""!==e.trim());return`<p>${t.map(e=>`<s>${e.trim()}</s>`).join(" ")}</p>`}).join("\n");return`<p><s>USER-PROVIDED STORY START:</s><break time="300ms"/></p>\n${e}\n<p><s>USER-PROVIDED STORY END. Source: User Provided.</s></p><break time="500ms"/>\n` }

        async function handleGenerateCategoryNews(categoryKey, isCalledFromBatch = false) {
            const categoryConfig = sectionDetails[categoryKey];
            const selectedLLMName = llmSelector.options[llmSelector.selectedIndex]?.text || "No Model";
            const categoryDisplayName = categoryKey.replace(/_/g, ' & ');
            
            if (!isCalledFromBatch && !llmSelector.value) { 
                 errorMessage.textContent = "No AI model selected/enabled. Check Settings.";
                 statusMessage.textContent = "Generation failed."; return Promise.reject();
            }

            categoryConfig.contentArea.innerHTML = `<div class="p-2 text-sm text-slate-400">Generating with ${selectedLLMName}...</div>`;
            categoryConfig.contentArea.classList.remove('expanded');
            categoryConfig.data = ""; 
            if(categoryConfig.copyButton) categoryConfig.copyButton.classList.add('hidden');
            if(categoryConfig.expandButton) {
                categoryConfig.expandButton.classList.add('hidden');
                categoryConfig.expandButton.textContent = 'Expand';
            }
            
            const newsSectionElement = document.querySelector(`.news-section[data-tab-content="${categoryKey}"]`);
            if (newsSectionElement) newsSectionElement.classList.remove('hidden'); 

            if (!isCalledFromBatch) statusMessage.textContent = `Generating ${categoryDisplayName} with ${selectedLLMName}...`;
            errorMessage.textContent = ''; 
            
            const currentTimeFrame = localStorage.getItem('selectedTimeFrame') || '24h'; 
            const timeFrameText = getTimeFrameText(currentTimeFrame);
            const userBlockedTerms = hiddenBlockedTermsInput.value; // Use the hidden input's value
            const customHeaderForLLM_SSML = (localStorage.getItem('customHeaderText') || '').trim();
            let weatherStringForLLM_SSML = localStorage.getItem('enableWeather') === 'true' ? await fetchLocalWeather() : "";
            const pastedStorySSML = formatPastedStoryToSSML(internalCustomStoryValue);

            let finalPromptTemplateKey = `promptFallback${categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1).replace(/_/g, '').replace(/tv$/, 'Tv')}`;
            if (categoryKey === 'local') finalPromptTemplateKey = 'promptFallbackLocal';
            let finalPromptTemplate = getPromptFromStorage(finalPromptTemplateKey, categoryKey);
            
            let newsSourceInfo = `(using ${selectedLLMName}'s internal knowledge)`;
            const useAnyExternalNews = ['enableGnews','enableNewsApiOrg','enableGuardian','enableNyt'].some(k => localStorage.getItem(k) === 'true' && localStorage.getItem(k.replace('enable','').toLowerCase() + (k.includes('Org') ? 'Key' : 'ApiKey')));
            let rawNewsDataForPrompt = "";

            if (useAnyExternalNews) {
                try {
                    rawNewsDataForPrompt = await fetchNewsFromSources(categoryKey, userBlockedTerms, currentTimeFrame);
                    if (!(rawNewsDataForPrompt.startsWith("No recent articles found") || rawNewsDataForPrompt.startsWith("Error fetching"))) {
                        finalPromptTemplateKey = 'promptNewsProcessing'; 
                        finalPromptTemplate = getPromptFromStorage(finalPromptTemplateKey, categoryKey);
                        newsSourceInfo = `(processing fetched stories with ${selectedLLMName})`;
                    } else if (!isCalledFromBatch) statusMessage.textContent = rawNewsDataForPrompt + " Falling back to AI knowledge.";
                } catch (fetchError) {
                    if (!isCalledFromBatch) errorMessage.textContent = `News fetch failed: ${fetchError.message}. Falling back to AI knowledge.`;
                    console.error("News Fetch Error:", fetchError);
                }
            } else if (!isCalledFromBatch) { 
                statusMessage.textContent = "External news fetching disabled/no keys. AI using internal knowledge.";
            }
            
            let locationContextForPrompt = categoryKey === 'local' ? (localStorage.getItem('userLocationInfo') ? ` for ${localStorage.getItem('userLocationInfo')}` : " for a general local area") : "";

            let finalPrompt = finalPromptTemplate
                .replace('{{RAW_NEWS_DATA}}', rawNewsDataForPrompt)
                .replace('{{CATEGORY_NAME}}', categoryDisplayName)
                .replace('{{TIME_FRAME_TEXT}}', timeFrameText)
                .replace('{{CUSTOM_HEADER}}', customHeaderForLLM_SSML ? `<p><s>${customHeaderForLLM_SSML}</s></p><break time="700ms"/>` : '')
                .replace('{{WEATHER_FORECAST}}', weatherStringForLLM_SSML) 
                .replace('{{PASTED_STORY_SSML}}', pastedStorySSML)
                .replace('{{LOCATION_CONTEXT}}', locationContextForPrompt) 
                .replace('{{BLOCKED_TERMS_INSTRUCTION}}', (userBlockedTerms.trim() !== "") ? `\n\nIMPORTANT: Avoid: ${userBlockedTerms}.` : "");

            if (finalPromptTemplateKey.startsWith('promptFallback')) {
                 let subject = "general topics", specifics = "covering various current events."; 
                 const catSpecifics = { 
                    tech: ["technology", "innovations, new products, company updates, significant tech trends, or cybersecurity news from reputable tech news outlets and official sources."], 
                    movies_tv: ["movies and TV", "new releases, casting announcements, production updates, box office analysis, or critical reviews of films and television shows, based on information from established entertainment news sources and official studio announcements."],
                    automotive: ["automotive topics", "new vehicle releases, automotive industry trends, technological advancements in cars (like EVs, autonomous driving), motorsport news, or significant company news from reputable automotive publications and official sources."],
                    lifestyle: ["lifestyle topics", "trends and news in areas such as home and garden, wellness, travel, personal development, fashion, or food, based on information from established lifestyle publications and reputable sources."],
                    science: ["science and nature", "scientific discoveries, research breakthroughs, space exploration, environmental news, and nature-related developments from reputable scientific journals and established science news outlets."],
                    business: ["business", "significant company news, market trends, economic developments, entrepreneurship, and corporate strategies from reputable business news sources."],
                    finance: ["finance", "stock market analysis, investment strategies, personal finance advice, banking news, and financial regulations from established financial news outlets."],
                    politics: ["politics", "government activities, elections, legislative developments, political campaigns, and international relations from reputable political news sources."],
                    health: ["health", "medical breakthroughs, public health issues, wellness advice, fitness trends, and nutrition information from trusted health organizations and news sources."],
                    world: ["world affairs", "major international events, global affairs, conflicts, diplomacy, and significant developments from around the world from reputable international news services."],
                    sports: ["sports", "results, analysis, and news from various sports including major leagues, tournaments, and athletic achievements from established sports news outlets."],
                    entertainment: ["entertainment", "celebrity news, arts, music releases, cultural events, and general entertainment industry updates from reputable entertainment news sources."],
                    gaming: ["gaming", "video game releases, eSports, gaming industry news, hardware reviews, and trends in interactive entertainment from established gaming publications."],
                    culture: ["culture", "societal trends, arts, literature, traditions, heritage, and cultural phenomena from reputable cultural news sources and publications."],
                    opinion: ["opinion", "diverse viewpoints, editorials, and commentary on current events and societal issues from various columnists and thought leaders."],
                    local: ["local news", "community events, local government news, human interest stories, and developments relevant to the specified area (e.g., {{LOCATION_CONTEXT}})."],
                    travel: ["travel", "travel destinations, tourism news, travel tips, cultural experiences, and adventure travel from reputable travel publications."],
                    food: ["food", "culinary trends, restaurant reviews, recipes, food industry news, and nutritional information from established food and cooking publications."],
                    education: ["education", "news related to schools, universities, educational policies, learning methods, and advancements in the field of education from reputable sources."]
                 };
                 if(catSpecifics[categoryKey]) { 
                    subject = catSpecifics[categoryKey][0]; 
                    specifics = catSpecifics[categoryKey][1];
                } else { 
                    subject = categoryKey.replace(/_/g, ' ');
                }
                 finalPrompt = finalPrompt.replace('{{CATEGORY_SUBJECT}}', subject).replace('{{CATEGORY_SPECIFICS}}', specifics);
            }

            try {
                const generatedSSML = await callSelectedLLM(finalPrompt, isCalledFromBatch ? statusMessage.textContent : `Crafting ${categoryDisplayName} stories ${newsSourceInfo}...`);
                categoryConfig.data = generatedSSML || ""; 
                
                if (categoryConfig.data.trim()) {
                    categoryConfig.contentArea.textContent = stripSSML(categoryConfig.data); 
                    if(categoryConfig.copyButton) categoryConfig.copyButton.classList.remove('hidden');
                    if(categoryConfig.expandButton && stripSSML(categoryConfig.data).split('\n').length > 5) {
                         categoryConfig.expandButton.classList.remove('hidden');
                    }
                } else {
                    categoryConfig.contentArea.textContent = `${categoryConfig.initialPlaceholder} (No content by AI).`;
                    if(categoryConfig.copyButton) categoryConfig.copyButton.classList.add('hidden');
                    if(categoryConfig.expandButton) categoryConfig.expandButton.classList.add('hidden');
                }
                if (!isCalledFromBatch) {
                    statusMessage.textContent = `${categoryDisplayName} stories generated ${newsSourceInfo}!`;
                    updateMainContentTabs([categoryKey]); 
                }
                updateCopyAllGeneratedButtonVisibility(); 
            } catch (error) {
                categoryConfig.contentArea.innerHTML = `<div class="p-4 text-red-400">Failed. ${errorMessage.textContent || 'Unknown error.'}</div>`;
                if (!isCalledFromBatch) statusMessage.textContent = `${categoryDisplayName} generation failed.`;
                throw error; 
            }
        }
        
        async function copyToClipboard(ssmlText, buttonElement, successText, openNotebook = false) { const t=stripSSML(ssmlText),o=customHeaderTextInp.value.trim();let e="";if("true"===localStorage.getItem("enableWeather")){const n=await fetchLocalWeather();e=stripSSML(n)}let r="";o&&(r+=`${o}\n\n`),e&&""!==e.trim()&&!e.startsWith("Error")&&!e.startsWith("Local weather could not be fetched")&&(r+=`${e}\n\n`),r+=t,console.log("Content being copied:",r);if(!r||""===r.trim())return statusMessage.textContent="No content to copy.",!1;const s=document.createElement("textarea");s.value=r,s.style.position="fixed",document.body.appendChild(s),s.focus(),s.select();try{document.execCommand("copy"),statusMessage.textContent=successText,buttonElement&&!openNotebook&&setTimeout(()=>{buttonElement.textContent=buttonElement.textContent.replace("Copied!","").trim()},2e3),openNotebook&&window.open("https://notebooklm.google.com/","_blank")}catch(t){return console.error("Failed to copy: ",t),statusMessage.textContent="Failed to copy.",errorMessage.textContent="Copying failed.",!1}finally{document.body.removeChild(s)}return!0 }
        async function copyAllAndOpenNotebookLM() { let t="";let o=0;["tech","general","movies_tv","automotive","lifestyle","science","business","finance","politics","health","world","sports","entertainment","gaming","culture","opinion","local","travel","food","education"].forEach(e=>{sectionDetails[e]&&sectionDetails[e].data&&""!==sectionDetails[e].data.trim()&&(t+=`\n\n--- ${e.toUpperCase().replace(/_/g," & ")} ---\n`+stripSSML(sectionDetails[e].data),o++)}),0!==o?(t=t.trim(),await copyToClipboard(t,copyAndOpenNotebookBtn,"All stories copied! Opening NotebookLM...",!0)):statusMessage.textContent="No stories generated to copy." }
        async function copyCategoryContentToClipboard(categoryKey) { const t=sectionDetails[categoryKey];if(t.data&&""!==t.data.trim())await copyToClipboard(t.data,t.copyButton,`${categoryKey.replace(/_/g," & ")} stories copied!`);else statusMessage.textContent=`No ${categoryKey.replace(/_/g," & ")} stories to copy.` }
        async function copyAllGeneratedContentToClipboard() { let t="";let o=0;["tech","general","movies_tv","automotive","lifestyle","science","business","finance","politics","health","world","sports","entertainment","gaming","culture","opinion","local","travel","food","education"].forEach(e=>{sectionDetails[e]&&sectionDetails[e].data&&""!==sectionDetails[e].data.trim()&&(t+=`\n\n--- ${e.toUpperCase().replace(/_/g," & ")} ---\n`+stripSSML(sectionDetails[e].data),o++)}),0!==o?(t=t.trim(),await copyToClipboard(t,copyAllGeneratedBtn,"All generated stories copied!")):statusMessage.textContent="No stories generated to copy." }
        
        function updateCopyAllGeneratedButtonVisibility() {
            const anyGenerated = Object.values(sectionDetails).some(s => s.data?.trim());
            copyAllGeneratedBtn.classList.toggle('hidden', !anyGenerated);
            copyAndOpenNotebookBtn.classList.toggle('hidden', !anyGenerated); 
            allContentWrapper.classList.toggle('hidden', !anyGenerated); 
        }
        
        const allActionButtons = document.querySelectorAll('.btn-category, #generateSelectedBtn');
        function disableAllActionButtons() { allActionButtons.forEach(t=>{t.classList.add("btn-disabled"),t.disabled=!0}),settingsBtn&&(settingsBtn.classList.add("btn-disabled"),settingsBtn.disabled=!0) }
        function enableAllActionButtons() { allActionButtons.forEach(t=>{t.classList.remove("btn-disabled"),t.disabled=!1}),settingsBtn&&(settingsBtn.classList.remove("btn-disabled"),settingsBtn.disabled=!1) }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadPersistentSettings(); 
            updateCopyAllGeneratedButtonVisibility(); 
            if (settingsPanel) { 
                settingsPanel.style.display = 'flex'; 
                settingsPanel.classList.add('translate-x-full'); 
            }
            if (settingsOverlay) settingsOverlay.classList.add('hidden'); 
            document.querySelectorAll('#allContentWrapper .tab-content').forEach(tc => tc.classList.add('hidden'));
            if(themeSelector) themeSelector.addEventListener('change', (e) => applyTheme(e.target.value));
        });
    </script>
</body>
</html>
